{% extends "base.html" %}
{% block content %}

<div class="container mt-2" id="cardsContainer" xmlns="http://www.w3.org/1999/html">
    <div class="input-group mb-4">
      <div class="input-group-prepend">
          <div class="input-group-text"><i class="fa fa-search"></i></div>
      </div>
      <input id="cardFilter" class="form-control py-2 border" type="text" onkeyup="cardFilter()" placeholder="Search...">
    </div>

 {% for tosca_name, tosca in templates_info.items() %}
    {% if loop.index % 3 == 1 %}
    <div class="card-deck">
    {% endif %}

        <div class="card mb-4" style="max-width: 20rem; max-height: 25rem;">
            <div class="card-body">
                <h5 class="card-title text-center">
                    <strong>
                    {% if tosca['metadata']['display_name'] is defined %}{{tosca['metadata']['display_name']}}{% else %}{{tosca_name}}{% endif %}
                    </strong>
                </h5>
            </div>
            <div class="wrapper">
                <img class="card-img-bottom img-fluid" src="{{tosca['metadata']['icon']}}" alt="Card image cap">
            {% if tosca['metadata']['access_locked'] %}
                <div class="ribbon red"><span>LOCKED</span></div>
            {% else %}
		        {% if tosca['metadata']['tag'] is defined %}
		        <div class="ribbon {{tosca['metadata']['tag_color']}}"><span>{{tosca['metadata']['tag']}}</span></div>
                {% endif %}
            {% endif %}
            </div>
            <div class="card-img-overlay text-center" style="z-index: 1;">
                <h5>
                    <strong>
                    {% if tosca['metadata']['display_name'] is defined %}{{tosca['metadata']['display_name']}}{% else %}{{tosca_name}}{% endif %}
                    </strong>
                </h5>
                <div id="toscaDescription" class="card-text tosca-descr"><small>{{tosca['description'] | safe}}</small></div>
                <div class="row justify-content-center">
                    <div class="col-4">
                        <a class="badge badge-pill badge-info text-left read_more" tabindex="0" data-toggle="popover" title="Full description" data-trigger="focus" data-html="true" data-content="{{tosca['description']}}">Read More</a>
                    </div>
                    {% if tosca['metadata']['access_locked'] %}
                    {% set pre_tasks = tosca['metadata']['authorization_required'] %}
                    <div class="col-4">
                        {% if tosca['metadata']['display_name'] is defined %}{% set service_label = tosca['metadata']['display_name'] %}{% else %}{% set service_label = tosca_name %}{% endif %}
                        <a role="button" data-id="{{ service_label }}" data-action="{{ url_for('home_bp.sendaccessrequest', service_type=service_label) }}" class="badge badge-pill badge-danger" data-toggle="modal" data-target="#requestAccess" > Request Access</a>
                    </div>
                    {% elif tosca['metadata']['tag'] is defined and tosca['metadata']['tag']|upper == 'MAINTENANCE'   %}
                       <!-- maintenance: do not show configure button -->
                    {% else %}
                    <div class="col-4">
                    {% import 'configure.j2' as configure %}
                    {{ configure.create_configure_button(enable_template_groups, tosca_name, tosca['metadata']['allowed_groups']) }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% if loop.index % 3 == 0 %}
    </div>
    {% endif %}
    {% endfor %}
    {% if templates_info|count % 3 != 0 %}
    </div>
    {% endif %}
    <!-- Modal begin -->
    <div class="modal fade" id="requestAccess" tabindex="-1" role="dialog" aria-labelledby="requestAccess" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header px-lg-5">
                    <h5 class="modal-title" id="listingModalLabel">Request Access</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
                </div>
                <div class="modal-body">
                    <form id="requestform" action="#" method="post">
                        <div class="form-group">
                            <label for="username"><strong>User</strong></label>
                            <div>
                                <input type="text" class="form-control" name="username" id="username" value="{{ session['username'] }}" disabled>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="email"><strong>Mail</strong></label>
                            <div>
                                <input type="email" class="form-control" name="email" id="email" value="{{ session['useremail'] }}" data-toggle="email">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="message">Message</label>
                            <textarea required class="form-control" name="message" id="message" placeholder="Please, provide a detailed motivation for your request." rows="3"></textarea>
                        </div>
                        <input type="hidden" name="service_type" value="">
                        <div class="form-group">
                            <div>
                                <button type="submit" class="btn btn-success">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!--  end Modal -->
</div>

<script>
$(document).ready(function(){
  $('[data-toggle="popover"]').popover();
});
</script>


<script>

//init dotdotdot
$(".tosca-descr").dotdotdot({
    ellipsis    : ' [...] ',
    wrap        : 'word',
    after       : "a.read_more",
    watch       : true,
    height      : 70,
    callback    : function( isTruncated, orgContent ) {

        if(isTruncated == true){
            //$(".read_more").css("visibility","visible");
        }
        else {
            $(this).parent().find('.read_more').css("display","none");
            //$(".read_more").css("display","none");
        }

    }
});
</script>


<style>

.wrapper {
  position: relative;
  overflow: visible;
  top: 5px;
  right: -5px
}

.wrapper:after {
  content: '';
  display: block;
  padding-top: 30%;
}

.wrapper img {
  object-fit: contain;
  height: 85%;
  position: absolute;
  top: 0;
}

.card-img-overlay {
  //background-color: #3374FF;
  background-color: #213752;
  color: white;
  //font-family: 'Abel', sans-serif;
  //font-family: 'Roboto Condensed', sans-serif;
  opacity: 0.90;
}


.popover {
    border: 2px solid #5BC0DE;
    max-width: 50%;
}

.popover-header {
    background-color: #5BC0DE;
    color: #FFFFFF;
    margin: 2;
    //font-size: 22px;
    text-align:center;
    //font-family: 'Abel', sans-serif;
    //font-family: 'Roboto Condensed', sans-serif;
}

.popover-body {
    //background-color: white;
    //color: #FFFFFF;
    padding: 25px;
    //overflow-y: auto;
    //max-height: 150px;
}

/* The ribbons */
/* Default ribbon is green. */
.ribbon {
   position: absolute;
   right: 0px; bottom: 0px;
   z-index: 1;
   overflow: visible;
   width: 75px; height: 75px; 
   text-align: right;
   transform: rotate(-270deg);
   -webkit-transform: rotate(-270deg);
}

.ribbon span {
   border-radius: 0px 0px 16px 16px;
   font-size: 10px;
   color: #fff; 
   text-transform: uppercase; 
   text-align: center;
   font-weight: bold; line-height: 20px;
   transform: rotate(225deg);
   width: 100px; display: block;
   background: #79A70A;
   background: linear-gradient(#79A70A 0%, #9BC90D 100%);
   box-shadow: 0 -3px 10px -5px rgba(0, 0, 0, 1);
   position: absolute;
   top: 19px; right: -21px;
}

.ribbon span::before {
   content: '';
   position: absolute; 
   right: 0px; bottom: 100%;
   z-index: -1;
   border-left: 3px solid #79A70A;
   border-right: 3px solid transparent;
   border-bottom: 3px solid transparent;
   border-top: 3px solid #79A70A;
   transform: rotate (180deg);
   -webkit-transform: rotate(180deg);
}

.ribbon span::after {
   content: '';
   position: absolute; 
   left: 0px; bottom: 100%;
   z-index: -1;
   border-right: 3px solid #79A70A;
   border-left: 3px solid transparent;
   border-bottom: 3px solid transparent;
   border-top: 3px solid #79A70A;
   transform: rotate (180deg);
   -webkit-transform: rotate(180deg);
}

.green span {background: linear-gradient(#79A70A 0%, #9BC90D 100%);}
.green span::before {border-left-color: #79A70A; border-top-color: #79A70A;}
.green span::after {border-right-color: #79A70A; border-top-color: #79A70A;}

.red span {background: linear-gradient(#8F0808 0%, #F70505 100%);}
.red span::before {border-left-color: #8F0808; border-top-color: #8F0808;}
.red span::after {border-right-color: #8F0808; border-top-color: #8F0808;}

.blue span {background: linear-gradient(#1e5799 0%, #2989d8 100%);}
.blue span::before {border-left-color: #1e5799; border-top-color: #1e5799;}
.blue span::after {border-right-color: #1e5799; border-top-color: #1e5799;}

.yellow span {background: linear-gradient(#b07620 0%, #ffbf00 100%);}
.yellow span::before {border-left-color: #b07620; border-top-color: #b07620;}
.yellow span::after {border-right-color: #b07620; border-top-color: #b07620;}

</style>


<script>

$(document).ready(function() {

  $( ".card-img-overlay").hide();

  $( ".card" ).hover(
  function() {
    $(this).addClass('shadow-lg').css('cursor', 'pointer');
    $(this).find('.card-img-overlay').show();
  }, function() {
    $(this).removeClass('shadow-lg');
    $(this).find('.card-img-overlay').hide();
  }
);

});

</script>

<script>
function cardFilter() {
    var input, filter, cards, cardContainer, h5, title, i;
    input = document.getElementById("cardFilter");
    filter = input.value.toUpperCase();
    cardContainer = document.getElementById("cardsContainer");
    cards = cardContainer.getElementsByClassName("card");
    for (i = 0; i < cards.length; i++) {
        title = cards[i].querySelector(".card-body .card-title");
        if (title.innerText.toUpperCase().indexOf(filter) > -1) {
            cards[i].style.display = "";
        } else {
            cards[i].style.display = "none";
        }
    }
}
</script>


<script>
$('#requestAccess').on('show.bs.modal', function (event) {
    var target = $(event.relatedTarget) // Button that triggered the modal
    // Extract info from data-* attributes
    var service = target.data('id')
    var url = target.data('action')

    var modal = $(this)
    modal.find('.modal-title').text('Request access to service \"' + service + '\"')
    modal.find('input[name="service_type"]').val(service)
    modal.find('#requestform').prop('action', url)
})
</script>

{% endblock %}
